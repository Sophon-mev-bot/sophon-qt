/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

task prepare {
    doLast {
        switch (rootProject.ext.BuildType) {
            //only se5 support hdmi output
            case "bm1684_soc":
                exec {
                    workingDir "."
                    commandLine 'tar', 'xvf', 'qtbase-5.14.tgz'
                    println "tar xvf qtbase-5.14"
                }
            default:
                break
        }
    }
}

task build {
	dependsOn "prepare"
	doLast {
		exec {
			workingDir "."
			commandLine './install/bin/qmake', "SophonOS.pro", '-spec', 'linux-aarch64-gnu-g++', 'CONFIG+=qtquickcompiler'
		}
		exec {
			workingDir "."
			commandLine 'make', '-j9'
		}
		exec {
			workingDir "."
			commandLine 'aarch64-linux-gnu-strip',  '--strip-unneeded', 'SophonOS'
		}
		println "build SophonOS"
	}
}

// 因为 ext.BuildTye只能在运行时获取,在配置时还未初始化
// 所以这里我们默认都会跑HDMI的task, 只是只有当其等于 bm1684_soc时才会真正执行编译和拷贝动作
task copyFiles {
    dependsOn "build"
    doLast {
        switch (rootProject.ext.BuildType) {
            //only se5 support hdmi output
            case "bm1684_soc":
                println "task HDMI:copyFiles: BuildType=" + rootProject.ext.BuildType
            def desDir = "../../output/${rootProject.ext.BuildType}/system/data/sophon_gate/SophonHDMI"
            copy {
                from "."
                into desDir
                include "SophonOS"
                include "run_hdmi_show.sh*"
                include "hdmi_status.sh*"
                include "hdmi_status_docker.sh*"
                eachFile { println it.path }
            }
            println "Copy HDMI files to $desDir . Done!"
            default:
                break
        }
    }
}
